-- 1. 廠別主檔
CREATE TABLE factories (
    id SERIAL PRIMARY KEY,
    code VARCHAR(10) UNIQUE NOT NULL,  -- AMA, AMC, AMD
    name VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 2. 工單主檔 (關聯主鍵)
CREATE TABLE work_orders (
    id SERIAL PRIMARY KEY,
    factory_code VARCHAR(10) NOT NULL,
    order_number VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(factory_code, order_number),
    FOREIGN KEY (factory_code) REFERENCES factories(code)
);

-- 3. 零件分類主檔 (從 Shelf Life Code 統計表)
CREATE TABLE part_categories (
    id SERIAL PRIMARY KEY,
    part_number VARCHAR(50) UNIQUE NOT NULL,
    category VARCHAR(20) NOT NULL,  -- 零件/配件/精品
    shelf_life_code VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 4. 零件出貨記錄
CREATE TABLE part_shipments (
    id SERIAL PRIMARY KEY,
    factory_code VARCHAR(10) NOT NULL,
    order_number VARCHAR(50) NOT NULL,
    part_number VARCHAR(50) NOT NULL,
    quantity INTEGER,
    amount DECIMAL(12, 2),
    shipment_date DATE,
    file_upload_id VARCHAR(100),  -- 追蹤來源檔案
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (factory_code, order_number) REFERENCES work_orders(factory_code, order_number),
    FOREIGN KEY (part_number) REFERENCES part_categories(part_number)
);

-- 5. 零件銷售記錄
CREATE TABLE part_sales (
    id SERIAL PRIMARY KEY,
    factory_code VARCHAR(10) NOT NULL,
    order_number VARCHAR(50) NOT NULL,
    part_number VARCHAR(50) NOT NULL,
    quantity INTEGER,
    amount DECIMAL(12, 2),
    sale_date DATE,
    file_upload_id VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (factory_code, order_number) REFERENCES work_orders(factory_code, order_number),
    FOREIGN KEY (part_number) REFERENCES part_categories(part_number)
);

-- 6. 技師績效記錄
CREATE TABLE technician_performance (
    id SERIAL PRIMARY KEY,
    factory_code VARCHAR(10) NOT NULL,
    order_number VARCHAR(50),
    technician_name VARCHAR(100) NOT NULL,
    work_hours DECIMAL(8, 2),
    salary DECIMAL(12, 2),
    bonus DECIMAL(12, 2),
    performance_date DATE,
    file_upload_id VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (factory_code, order_number) REFERENCES work_orders(factory_code, order_number)
);

-- 7. 維修收入分類記錄
CREATE TABLE maintenance_income (
    id SERIAL PRIMARY KEY,
    factory_code VARCHAR(10) NOT NULL,
    order_number VARCHAR(50) NOT NULL,
    income_category VARCHAR(100),  -- 收入類別
    amount DECIMAL(12, 2),
    income_date DATE,
    file_upload_id VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (factory_code, order_number) REFERENCES work_orders(factory_code, order_number)
);

-- 8. 檔案上傳記錄 (避免重複上傳)
CREATE TABLE file_uploads (
    id SERIAL PRIMARY KEY,
    file_name VARCHAR(255) NOT NULL,
    file_hash VARCHAR(64) UNIQUE NOT NULL,  -- MD5 或 SHA256
    factory_code VARCHAR(10),
    file_type VARCHAR(50),  -- 零件出貨/零件銷售/技師績效/維修收入/Shelf Life
    upload_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    record_count INTEGER,
    status VARCHAR(20) DEFAULT 'processed'  -- processed/skipped/overwritten
);

-- 建立索引提升查詢效能
CREATE INDEX idx_work_orders_factory ON work_orders(factory_code);
CREATE INDEX idx_part_shipments_order ON part_shipments(factory_code, order_number);
CREATE INDEX idx_part_sales_order ON part_sales(factory_code, order_number);
CREATE INDEX idx_technician_factory ON technician_performance(factory_code);
CREATE INDEX idx_maintenance_order ON maintenance_income(factory_code, order_number);
CREATE INDEX idx_file_hash ON file_uploads(file_hash);

-- 建立 View 用於業績查詢
CREATE VIEW factory_performance AS
SELECT 
    f.code as factory_code,
    f.name as factory_name,
    COUNT(DISTINCT wo.order_number) as total_orders,
    SUM(mi.amount) as total_income,
    SUM(ps.amount) as parts_sales,
    SUM(tp.salary + tp.bonus) as total_labor_cost
FROM factories f
LEFT JOIN work_orders wo ON f.code = wo.factory_code
LEFT JOIN maintenance_income mi ON wo.factory_code = mi.factory_code AND wo.order_number = mi.order_number
LEFT JOIN part_sales ps ON wo.factory_code = ps.factory_code AND wo.order_number = ps.order_number
LEFT JOIN technician_performance tp ON wo.factory_code = tp.factory_code AND wo.order_number = tp.order_number
GROUP BY f.code, f.name;

CREATE VIEW technician_performance_summary AS
SELECT 
    technician_name,
    factory_code,
    COUNT(DISTINCT order_number) as total_orders,
    SUM(work_hours) as total_hours,
    SUM(salary) as total_salary,
    SUM(bonus) as total_bonus,
    SUM(salary + bonus) as total_income
FROM technician_performance
GROUP BY technician_name, factory_code;
